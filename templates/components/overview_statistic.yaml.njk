## -----------------
## 
## overview_statistic
## Calculate index for selected period and show statistic along with movement from previous period
## 
## vars:
##   id: _string_ (REQUIRED) - id for the component.
##   span: _integer_ - Span of the component. Default 24.
##   size_auto: _boolean_ - Sets layout to flex if set to true. Default null
##   connectionId: _string_ (REQUIRED) - MongoDB collection connection id.
##   request: _string_ (REQUIRED) - Request name from which to read data.
##   index: _string_ (REQUIRED) - the index field used to calculate the monthly average on. [csi,nps]
##   division: _integer_ (REQUIRED) - which division to show. [company,sales,after_sales,parts,service]_[company,sales,after_sales,parts,service]
##   period: _integer_ (REQUIRED) - which period. [fytd,current]
##   index_name: _string_ (REQUIRED) - the index name used to label the field value.
##   title_font_size: _integer_ - the font size of the title (the index_name). Default: 18.
##   index_font_size: _integer_ - the font size of the index score. Default: 60.
##   index_font_weight: _integer_ - the font weight of the index score. Default: 200.
##   subtitle_font_size:  _integer_ - the font size of the subtitle (the movement). Default: 16.
##   icon_size:  _integer_ - the font size of the subtitle (the movement). Default: 14.
##   hide_movement: _boolean_ - if true, hides the subtitle/ movement part. Default: false.
## ------------------

id: overview_statistic_{{ id }}
type: Box
layout:
  contentAlign: middle
  flex:
    _var:
      name: flex
      default: null
  span:
    _var:
      name: span
      default: 24
  sm:
    size: auto
blocks:
  - id: index_statistic_title_{{ id }}
    type: Html
    properties:
      html: 
        _nunjucks:
          template: |
            {% raw %}
            <p style='font-size: {{ font_size }}px; line-height:1; margin: 0; text-align:right;'>
              {{ index }}
            </p>
            {% endraw %}
          on:
            font_size:
              _var:
                name: title_font_size
                default: 18
            index:
              _var: index_name # Might be an operator so don't use njks
  - id: score_{{ id }}
    type: Html
    properties:
      html:
        _nunjucks:
          template: |
            {% raw %}
            <p style='font-size:{{ font_size }}px; font-weight: {{ font_weight }}; line-height:1; margin: 5px; text-align:right;'>
              {{ "-" if score == "loading" else score | round(1) }}
            </p>
            {% endraw %}
          on:
            font_size:
              _var:
                name: index_font_size
                default: 60
            font_weight:
              _var:
                name: index_font_weight
                default: 200
            score:
              _get:
                key: 0.{{ index }}_{{ division }}_{{ period }}
                from:
                  _mql.expr:
                    on:
                      _state: true
                    expr:
                      $ifNull:
                        - _request: overview_index
                        - [{ {{ index }}_{{ division }}_{{ period }}: 'loading' }]
  - id: movement_box_{{ id }}
    type: Box
    layout:
      contentJustify: end
    visible:
      _not:
        _var:
          name: hide_movement
          default: false
    blocks:
      - id: movement_icon_{{ id }}
        type: Icon
        layout:
          flex: 0 1 auto
        style:
          marginRight: 8
        properties:
          size:
            _var:
              name: icon_size
              default: 14
          name:
            _mql.expr:
              expr:
                $switch:
                  branches:
                    - case:
                        $gt:
                          - ${{ index }}_{{ division }}_difference
                          - 0
                      then: ArrowUpOutlined
                    - case:
                        $lt:
                          - ${{ index }}_{{ division }}_difference
                          - 0
                      then: ArrowDownOutlined
                    - case:
                        $eq:
                          - ${{ index }}_{{ division }}_difference
                          - 0
                      then: MinusOutlined
                  default: LoadingOutlined
              on:
                _get:
                  key: '0'
                  from:
                    _if_none:
                      - _request: overview_index
                      - [{}]
          style:
            color:
              _mql.expr:
                expr:
                  $switch:
                    branches:
                      - case:
                          $gt:
                            - ${{ index }}_{{ division }}_difference
                            - 0
                        then: '#237804'
                      - case:
                          $lt:
                            - ${{ index }}_{{ division }}_difference
                            - 0
                        then: '#cf1322'
                    default: '#212121'
                on:
                  _get:
                    key: '0'
                    from:
                      _request: overview_index
      - id: movement_text_{{ id }}
        type: Html
        layout:
          flex: 0 1 auto
        properties:
          html:
            _nunjucks:
              template: |
                {% raw %}
                <font style='color: {{ color }}; font-size:{{ font_size }}px' >
                  {{ movement | abs | round(1) }}
                </font>
                <font style='color: {{ color }}; font-size:{{ font_size - 4 }}px' >
                  from previous month
                </font>
                {% endraw %}
              on:
                font_size:
                  _var:
                    name: subtitle_font_size
                    default: 16
                movement:
                  _get:
                    key: '0.{{ index }}_{{ division }}_difference'
                    from:
                      _request: overview_index
                color:
                  _mql.expr:
                    expr:
                      $switch:
                        branches:
                          - case:
                              $gt:
                                - ${{ index }}_{{ division }}_difference
                                - 0
                            then: '#1b5e20'
                          - case:
                              $lt:
                                - ${{ index }}_{{ division }}_difference
                                - 0
                            then: '#b71c1c'
                        default: '#212121'
                    on:
                      _get:
                        key: '0'
                        from:
                          _request: overview_index_{{ id }}