## -----------------
## 
## overview_csi_divisions_chart
## Calculate indices and render trend timeline chart.
## 
## vars:
##   id: _string_ - id for the component.
##   connectionId: _string_ - MongoDB collection connection id.
##   span: _integer_ - Span of the component. Default 24.
##   height: _number_ - height of the timeline chart.
##   colors: [_string_] - colors of the timeline chart.
## ------------------

id: {{ id }}
type: EChart
layout:
  contentJustify: end
  span:
    _var:
      name: span
      default: 24
requests:
  - id: divisions_overview_{{ id }}
    type: MongoDBAggregation
    connectionId:
      _var: connectionId
    properties:
      pipeline:
        - $match:
            published: true
            department:
              $in: 
                _state: departments
        - $match:
            $expr:
              $and:
                - $gte:
                    - $Mnt
                    - $dateFromParts:
                        year:
                          $year:
                            _state: end_month
                        month: 
                          $subtract:
                            - $month:
                                _state: end_month
                            - 12
                - $lte:
                    - $Mnt
                    - _state: end_month
        - $group:
            _id: $Mnt
            financial_year:
              $first: $financial_year
            company_csi_den:
              $sum: 1
            company_csi_num:
              $sum: $csi
            company_csi:
              $avg: $csi
{% for item in departments %}
            {{ item.field }}_csi_den:
              $sum:
                $cond:
                  - $eq:
                    - $department
                    - {{ item.name }}
                  - 1
                  - 0
            {{ item.field }}_csi_num:
              $sum:
                $cond:
                  - $eq:
                    - $department
                    - {{ item.name }}
                  - $csi
                  - 0
            {{ item.field }}_csi:
              $avg:
                $cond:
                  - $eq:
                    - $department
                    - {{ item.name }}
                  - $csi
                  - null
{% endfor %}

{% for item in divisions %}
            {{ item.field }}_csi_den:
              $sum:
                $cond:
                  - $or:
{% for department in item.departments %}
                    - $eq:
                      - $department
                      - {{ department }}
{% endfor %}
                  - 1
                  - 0
            {{ item.field }}_csi_num:
              $sum:
                $cond:
                  - $or:
{% for department in item.departments %}
                    - $eq:
                      - $department
                      - {{ department }}
{% endfor %}
                  - $csi
                  - 0
            {{ item.field }}_csi:
              $avg:
                $cond:
                  - $or:
{% for department in item.departments %}
                    - $eq:
                      - $department
                      - {{ department }}
{% endfor %}
                  - $csi
                  - null
{% endfor %}
        - $sort:
            _id: 1
        - $project:
            Mnt: $_id
            financial_year: 1
            period:
              $subtract:
                - _state: end_month
                - $_id
            divisions:
              - name: Company
                score: $company_csi
                num: $company_csi_num
                den: $company_csi_den
                company_num: $company_csi_num
                company_den: $company_csi_den
{% for item in divisions %}
              - name: {{ item.name }}
                score: ${{ item.field }}_csi
                num: ${{ item.field }}_csi_num
                den: ${{ item.field }}_csi_den
                company_num: $company_csi_num
                company_den: $company_csi_den
{% endfor %}
{% for item in departments %}
              - name: {{ item.name }}
                score: ${{ item.field }}_csi
                num: ${{ item.field }}_csi_num
                den: ${{ item.field }}_csi_den
                company_num: $company_csi_num
                company_den: $company_csi_den
{% endfor %}
        - $unwind:
            path: $divisions
            includeArrayIndex: rank
        - $group:
            _id: $divisions.name
            rank:
              $first: $rank
            den_1month:
              $sum:
                $cond:
                  - $eq:
                    - $Mnt
                    - _state: end_month
                  - $divisions.den
                  - 0
            num_1month:
              $sum:
                $cond:
                  - $eq:
                    - $Mnt
                    - _state: end_month
                  - $divisions.num
                  - 0
            score_1month:
              $avg:
                $cond:
                  - $eq:
                    - $Mnt
                    - _state: end_month
                  - $divisions.score
                  - null

            den_3month:
              $sum:
                $cond:
                  - $lt:
                    - $period
                    - $multiply: [1000,60,60,24,31,3]
                  - $divisions.den
                  - 0
            num_3month:
              $sum:
                $cond:
                  - $lt:
                    - $period
                    - $multiply: [1000,60,60,24,31,3]
                  - $divisions.num
                  - 0

            den_6month:
              $sum:
                $cond:
                  - $lt:
                    - $period
                    - $multiply: [1000,60,60,24,31,6]
                  - $divisions.den
                  - 0
            num_6month:
              $sum:
                $cond:
                  - $lt:
                    - $period
                    - $multiply: [1000,60,60,24,31,6]
                  - $divisions.num
                  - 0

            den_12month:
              $sum: $divisions.den
            num_12month:
              $sum: $divisions.num
              
            den_fytd:
              $sum:
                $cond:
                  - $eq:
                    - $financial_year
                    - _state: max_financial_year
                  - $divisions.den
                  - 0
            num_fytd:
              $sum:
                $cond:
                  - $eq:
                    - $financial_year
                    - _state: max_financial_year
                  - $divisions.num
                  - 0

            company_den_fytd:
              $sum:
                $cond:
                  - $eq:
                    - $financial_year
                    - _state: max_financial_year
                  - $divisions.company_den
                  - 0
            company_num_fytd:
              $sum:
                $cond:
                  - $eq:
                    - $financial_year
                    - _state: max_financial_year
                  - $divisions.company_num
                  - 0
        - $sort: 
            rank: 1
        - $project:
            csi_1month: 
              $round:
                - $score_1month
                - 1
            csi_3month:
              $round:
                - $cond:
                    - $eq:
                        - $den_3month
                        - 0
                    - null
                    - $divide:
                        - $num_3month
                        - $den_3month
                - 1
            csi_6month:
              $round:
                - $cond:
                    - $eq:
                        - $den_6month
                        - 0
                    - null
                    - $divide:
                        - $num_6month
                        - $den_6month
                - 1
            csi_12month:
                - $cond:
                    - $eq:
                        - $den_12month
                        - 0
                    - null
                    - $divide:
                        - $num_12month
                        - $den_12month
                - 1
            csi_fytd:
              $round:
                - $cond:
                    - $eq:
                        - $den_fytd
                        - 0
                    - null
                    - $divide:
                        - $num_fytd
                        - $den_fytd
                - 1
            company_fytd:
              $round:
                - $cond:
                    - $eq:
                        - $company_den_fytd
                        - 0
                    - null
                    - $divide:
                        - $company_num_fytd
                        - $company_den_fytd
                - 1
loading:
  type: Skeleton
  properties: 
    height: 
      _var: height
style:
  height:
    _var: height
properties:
  init:
    height: 
      _var: height
  option:
    grid:
      left: 50
      top: 20
      right: 0
      bottom: 30%
    color:
      _array.concat:
        - _array.slice:
            - _var: colors
            - 0
            - _get:
                key: length
                from: 
                  _var: departments
        - '#000'
    dataset:
      source:
        _if_none:
          - _mql.aggregate:
              on:
                _request: divisions_overview_{{ id }}
              pipeline:
                - $addFields:
                    all:
                      $concat:
                        - "Company FYtD: [bold]"
                        - $toString: 
                            $ifNull:
                              - $round:
                                - $company_fytd
                                - 1
                              - ""
                        - "[/]\n"
                        - "1 Month: [bold]"
                        - $toString: 
                            $ifNull:
                              - $round:
                                - $csi_1month
                                - 1
                              - ""
                        - "[/]\n"
                        - "3 Months: [bold]"
                        - $toString: 
                            $round:
                              - $csi_3month
                              - 1
                        - "[/]\n"
                        - "6 Months: [bold]"
                        - $toString: 
                            $round:
                              - $csi_6month
                              - 1
                        - "[/]\n"
                        - "FYtD: [bold]"
                        - $toString: 
                            $round:
                              - $csi_fytd
                              - 1
                        - "[/]\n"
          - []
    legend:
      bottom: 10
    tooltip:
      trigger: axis
      axisPointer: 
        type: cross
    xAxis: 
      type: category
      axisLabel:
        rotate: 60
      axisPointer: 
        type: line
        snap: true
    yAxis:
      name: CSI
      nameLocation: middle
      nameRotate: 90
      nameGap: 30
      type: value
      min: 70
      max: 100
      axisPointer: 
        show: false
    series:
      - name: 1 Month
        type: bar
        symbol: none
        smooth: true
        emphasis:
          itemStyle:
            opacity: 1
        itemStyle:
          opacity: 0.6
        encode:
          x: _id
          y: csi_1month
      - name: 3 Months
        type: bar
        symbol: none
        smooth: true
        emphasis:
          itemStyle:
            opacity: 1
        itemStyle:
          opacity: 0.6
        encode:
          x: _id
          y: csi_3month
      - name: 6 Months
        type: bar
        symbol: none
        smooth: true
        emphasis:
          itemStyle:
            opacity: 1
        itemStyle:
          opacity: 0.6
        encode:
          x: _id
          y: csi_6month
      - name: FYtD
        type: bar
        symbol: none
        smooth: true
        emphasis:
          itemStyle:
            opacity: 1
        itemStyle:
          opacity: 0.6
        encode:
          x: _id
          y: csi_fytd
      - name: Company FYtD
        type: line
        symbol: none
        smooth: true
        lineStyle:
          width: 4
        encode:
          x: _id
          y: company_fytd